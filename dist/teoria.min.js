(function(){"use strict";function y(e,t){return e=n[e],t=n[t],e.distance>t.distance?t.distance+12-e.distance:t.distance-e.distance}function b(e,t,n){for(;n>0;n--)e+=t;return e}function w(e,t){if(typeof e!="string")return null;t=t||{},this.name=e,this.duration={value:t.value||4,dots:t.dots||0},this.accidental={value:0,sign:""};var n=/^([a-h])(x|#|bb|b?)(-?\d*)/i,r=/^([a-h])(x|#|bb|b?)([,\']*)$/i,i,s,o,u,a=e.match(n);if(a&&e===a[0]&&a[3].length!==0)o=a[1].toLowerCase(),u=parseInt(a[3],10),a[2].length>0&&(i=a[2].toLowerCase(),s=v[a[2]]);else{e=e.replace(/\u2032/g,"'").replace(/\u0375/g,","),a=e.match(r);if(!a||e!==a[0])throw new Error("Invalid note format");o=a[1],u=a[3],a[2].length>0&&(i=a[2].toLowerCase(),s=v[a[2]]);if(u.length===0)u=o===o.toLowerCase()?3:2;else if(u.match(/^'+$/)){if(o===o.toUpperCase())throw new Error("Format must respect the Helmholtz notation");u=3+u.length}else{if(!u.match(/^,+$/))throw new Error("Invalid characters after note name.");if(o===o.toLowerCase())throw new Error("Format must respect the Helmholtz notation");u=2-u.length}}this.name=o.toLowerCase(),this.octave=u,i&&(this.accidental.value=s,this.accidental.sign=i)}function E(e,t,n){var r=e>=8&&e%7===1?e%7*8:(e-1)%7+1,i=Math.ceil((e-r)/8),o=s[r-1];if(!(t in f[o.quality]))throw new Error("Invalid interval quality");this.interval=e,this.quality=t,this.direction=n==="down"?"down":"up",this.simpleInterval=r,this.simpleIntervalType=o,this.compoundOctaves=i}function S(e,n){if(!(e instanceof w))return null;n=n||"",this.name=e.name.toUpperCase()+e.accidental.sign+n,this.symbol=n,this.root=e,this.notes=[e],this.quality="major";var r,i,s,o,a,f="quality",l=["M3","P5","m7","M9","P11","M13"],c=2,p=[],d,v;n=n.replace(/[,\s\(\)]/g,""),d=n.split("/"),d.length===2?(n=d[0],d=d[1]):d=null;for(r=0,i=n.length;r<i;r++){if(!(s=n[r]))break;o=s.charCodeAt(r),a=r+3<=i?n.substr(r,3):null;switch(f){case"quality":var m;a&&u[a]?(m=h[u[a]],this.quality=u[a],r+=a.length-1):u[s]&&a!=="maj"?(m=h[u[s]],this.quality=u[s]):(m=h.major,r-=1),l[0]=m[0],l[1]=m[1],f="extension";break;case"extension":s=s==="1"&&n[r+1]?parseFloat(n.substr(r,2)):parseFloat(s);if(!isNaN(s)&&s!==6){c=(s-1)/2;if(c!==Math.round(c))throw new Error("Invalid interval extension: "+s.toString(10));r+=String(s).length-1}else s===6?(l[2]="M6",c<3&&(c=3)):r-=1;f="alterations";break;case"alterations":var g=n.substr(r).split(/(#|b|add|maj|sus)/),y,b=!1,E=!1;if(g.length===1)throw new Error("Invalid alterations");if(g[0].length!==0)throw new Error("Invalid token: '"+g[0]+"'");for(var S=1,x=g.length;S<x;S++){y=x>S+1?g[S+1]:null;switch(g[S]){case"maj":c<3&&(c=3),y==="7"&&S++,l[2]="M7";break;case"sus":var T="P4";if(y==="2"||y==="4")y==="2"&&(T="M2"),S++;l[0]=T;break;case"add":y&&!isNaN(parseFloat(y))&&(y==="9"?p.push("M9"):y==="11"?p.push("P11"):y==="13"&&p.push("M13"),S+=y.length);break;case"b":b=!0;break;case"#":E=!0;break;default:if(g[S].length===0)break;var N=parseFloat(g[S]),C,k=parseFloat(g[S]),L;if(isNaN(N)||String(N).length!==g[S].length)throw new Error("Invalid token: '"+g[S]+"'");if(N===6){E?l[2]="A6":b?l[2]="m6":l[2]="M6",c<3&&(c=3);continue}L=(k-1)/2-1,c<L+1&&(c=L+1);if(k<5||k===7||L!==Math.round(L))throw new Error("Invalid interval alteration: "+k.toString(10));C=l[L][0];if(E){if(C==="d")C="m";else if(C==="m")C="M";else if(C==="M"||C==="P")C="A"}else if(b)if(C==="A")C="M";else if(C==="M")C="m";else if(C==="m"||C==="P")C="d";l[L]=C+l[L].substr(1)}}f="ended"}if(f==="ended")break}l=l.slice(0,c).concat(p);if(d){d=t.note(d);var A=t.interval.between(e,d);d.octave-=A.direction==="up"?1:0,this.notes.splice(0,0,d)}for(r=0;r<l.length;r++){v=this.root.interval(l[r]);if(d&&v.toString(!0)===d.toString(!0))continue;this.notes.push(v)}}function x(e,n){var r,i,s;if(!(e instanceof w))throw new Error("Invalid Tonic");if(typeof n=="string"){r=n,n=t.scale.scales[n];if(!n)throw new Error("Invalid Scale")}else for(i in t.scale.scales)if(t.scale.scales.hasOwnProperty(i)&&t.scale.scales[i].toString()===n.toString()){r=i;break}this.name=r,this.notes=[],this.tonic=e,this.scale=n;for(i=0,s=n.length;i<s;i++)this.notes.push(t.interval(e,n[i]))}var t={},n={c:{name:"c",distance:0,index:0},d:{name:"d",distance:2,index:1},e:{name:"e",distance:4,index:2},f:{name:"f",distance:5,index:3},g:{name:"g",distance:7,index:4},a:{name:"a",distance:9,index:5},b:{name:"b",distance:11,index:6},h:{name:"h",distance:11,index:6}},r=["c","d","e","f","g","a","b"],i={.25:"longa",.5:"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},s=[{name:"first",quality:"perfect",size:0},{name:"second",quality:"minor",size:1},{name:"third",quality:"minor",size:3},{name:"fourth",quality:"perfect",size:5},{name:"fifth",quality:"perfect",size:7},{name:"sixth",quality:"minor",size:8},{name:"seventh",quality:"minor",size:10},{name:"octave",quality:"perfect",size:12}],o={first:0,second:1,third:2,fourth:3,fifth:4,sixth:5,seventh:6,octave:7,ninth:8,tenth:9,eleventh:10,twelfth:11,thirteenth:12,fourteenth:13,fifteenth:14},u={P:"perfect",M:"major",m:"minor","-":"minor",A:"augmented","+":"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished",aug:"augmented",dim:"diminished"},a={perfect:"P",major:"M",minor:"m",augmented:"A","doubly augmented":"AA",diminished:"d","doubly diminished":"dd"},f={perfect:{"doubly diminished":-2,diminished:-1,perfect:0,augmented:1,"doubly augmented":2},minor:{"doubly diminished":-2,diminished:-1,minor:0,major:1,augmented:2,"doubly augmented":3}},l={perfect:"perfect",major:"minor",minor:"major",augmented:"diminished","doubly augmented":"doubly diminished",diminished:"augmented","doubly diminished":"doubly augmented"},c={perfect:["doubly diminished","diminished","perfect","augmented","doubly augmented"],minor:["doubly diminished","diminished","minor","major","augmented","doubly augmented"]},h={major:["M3","P5"],minor:["m3","P5"],augmented:["M3","A5"],diminished:["m3","d5"],sus2:["M2","P5"],sus4:["P4","P5"],power:["P5"]},p={major:"M",minor:"m",augmented:"aug",diminished:"dim",power:"5"},d={"-2":"bb","-1":"b",0:"",1:"#",2:"x"},v={bb:-2,b:-1,"#":1,x:2},m={first:"1",tonic:"1",second:"2",third:"3",fourth:"4",fifth:"5",sixth:"6",seventh:"7",ninth:"9",eleventh:"11",thirteenth:"13"},g={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};w.prototype={key:function(e){var t;return e?(t=Math.ceil(n[this.name].distance/2),(this.octave-1)*7+3+t):(t=n[this.name].distance+this.accidental.value,(this.octave-1)*12+4+t)},fq:function(e){return e=e||440,e*Math.pow(2,(this.key()-49)/12)},scale:function(e){return t.scale(this,e)},interval:function(e,n){return t.interval(this,e,n)},transpose:function(e,n){var r=t.interval(this,e,n);return this.name=r.name,this.octave=r.octave,this.accidental=r.accidental,this},chord:function(e){return e=e||"major",e in p&&(e=p[e]),new S(this,e)},helmholtz:function(){var e=this.octave<3?this.name.toUpperCase():this.name.toLowerCase(),t=this.octave<3?",":"'",n=this.octave<2?2-this.octave:this.octave-3;return b(e+this.accidental.sign,t,n)},scientific:function(){return this.name.toUpperCase()+this.accidental.sign+this.octave},enharmonics:function(){var e=[],t=this.key(),n=this.interval("m2","up"),r=this.interval("m2","down"),i=n.key()-n.accidental.value,s=r.key()-r.accidental.value,o=t-i;return o<3&&o>-3&&(n.accidental={value:o,sign:d[o]},e.push(n)),o=t-s,o<3&&o>-3&&(r.accidental={value:o,sign:d[o]},e.push(r)),e},solfege:function(e,t){if(e instanceof x){var n=e.tonic.interval(this),r,i,s;return n.direction==="down"&&(n=n.invert()),t&&(s=(this.key(!0)-e.tonic.key(!0))/7,s=s>=0?Math.floor(s):-Math.ceil(-s),i=s>=0?"'":","),r=g[n.simple()],t?b(r,i,Math.abs(s)):r}throw new Error("Invalid Scale")},durationName:function(){return i[this.duration.value]},durationInSeconds:function(e,t){var n=60/e/(this.duration.value/4)/(t/4);return n*2-n/Math.pow(2,this.duration.dots)},scaleDegree:function(e){var t=e.tonic.interval(this);return t=t.direction==="down"||t.simpleInterval===8?t.invert():t,e.scale.indexOf(t.simple())+1},toString:function(e){var t=e?"":this.octave;return this.name.toLowerCase()+this.accidental.sign+t}},E.prototype={semitones:function(){return this.simpleIntervalType.size+this.qualityValue()+this.compoundOctaves*12},simple:function(){return a[this.quality]+this.simpleInterval.toString()},compound:function(){return a[this.quality]+(this.simpleInterval+this.compoundOctaves*7).toString()},isCompound:function(){return this.compoundOctaves>0},invert:function(){var e=this.simpleInterval;return e=9-e,new E(e,l[this.quality])},qualityValue:function(){var e=this.simpleIntervalType.quality,t=this.quality;return f[e][t]},equal:function(e){return this.interval===e.interval&&this.quality===e.quality},greater:function(e){var t=this.semitones(),n=e.semitones();return t===n?this.interval>e.interval:t>n},smaller:function(e){return!this.equal(e)&&!this.greater(e)},toString:function(){return this.compound()}},S.prototype={dominant:function(e){return e=e||"",new S(this.root.interval("P5"),e)},subdominant:function(e){return e=e||"",new S(this.root.interval("P4"),e)},parallel:function(e){e=e||"";if(this.chordType()!=="triad"||this.quality==="diminished"||this.quality==="augmented")throw new Error("Only major/minor triads have parallel chords");return this.quality==="major"?new S(this.root.interval("m3","down"),"m"):new S(this.root.interval("m3","up"))},chordType:function(){var e=this.notes.length,t,n,r,i,s;if(e===2)return"dyad";if(e===3){n={first:!1,third:!1,fifth:!1};for(i=0;i<e;i++)t=this.root.interval(this.notes[i]),r=t.invert(),t.simpleIntervalType.name in n?n[t.simpleIntervalType.name]=!0:r.simpleIntervalType.name in n&&(n[r.simpleIntervalType.name]=!0);s=n.first&&n.third&&n.fifth?"triad":"trichord"}else if(e===4){n={first:!1,third:!1,fifth:!1,seventh:!1};for(i=0;i<e;i++)t=this.root.interval(this.notes[i]),r=t.invert(),t.simpleIntervalType.name in n?n[t.simpleIntervalType.name]=!0:r.simpleIntervalType.name in n&&(n[r.simpleIntervalType.name]=!0);n.first&&n.third&&n.fifth&&n.seventh&&(s="tetrad")}return s||"unknown"},get:function(e){if(typeof e=="string"&&e in m){var t=s[o[e]].quality;t=t==="perfect"?"P":"M",e=this.root.interval(t+m[e]);for(var n=0,r=this.notes.length;n<r;n++)if(this.notes[n].name===e.name)return this.notes[n];return null}throw new Error("Invalid interval name")},interval:function(e,t){return new S(this.root.interval(e,t),this.symbol)},transpose:function(e,t){var n=new S(this.root.interval(e,t),this.symbol);return this.name=n.name,this.symbol=n.symbol,this.root=n.root,this.notes=n.notes,this.quality=n.quality,this},toString:function(){return this.name}},x.prototype={simple:function(){var e=[];for(var t=0,n=this.notes.length;t<n;t++)e.push(this.notes[t].toString(!0));return e},type:function(){var e=this.notes.length-2;if(e<8)return["di","tri","tetra","penta","hexa","hepta","octa"][e]+"tonic"},get:function(e){return typeof e=="string"&&e in m&&(e=parseInt(m[e],10)),this.notes[e-1]},solfege:function(e,t){var n,r,i=[];if(e)return this.get(e).solfege(this,t);for(n=0,r=this.notes.length;n<r;n++)i.push(this.notes[n].solfege(this,t));return i},interval:function(e,t){return new x(this.tonic.interval(e,t),this.scale)},transpose:function(e,t){var n=new x(this.tonic.interval(e,t),this.scale);return this.notes=n.notes,this.scale=n.scale,this.tonic=n.tonic,this}},t.note=function(e,t){return new w(e,t)},t.note.fromKey=function(e){var i=Math.floor((e-4)/12),s=e-i*12-4,o=n[r[Math.round(s/2)]],u=o.name;return o.distance<s?u+="#":o.distance>s&&(u+="b"),t.note(u+(i+1))},t.note.fromFrequency=function(e,n){var r,i,s;return n=n||440,r=49+12*((Math.log(e)-Math.log(n))/Math.log(2)),r=Math.round(r),s=n*Math.pow(2,(r-49)/12),i=1200*(Math.log(e/s)/Math.log(2)),{note:t.note.fromKey(r),cents:i}},t.note.fromMIDI=function(e){return t.note.fromKey(e-20)},t.chord=function(e,n){if(typeof e=="string"){var r,i;r=e.match(/^([a-h])(x|#|bb|b?)/i);if(r&&r[0])return i=typeof n=="number"?n.toString(10):"4",new S(t.note(r[0].toLowerCase()+i),e.substr(r[0].length))}else if(e instanceof w)return new S(e,n||"");throw new Error("Invalid Chord. Couldn't find note name")},t.interval=function(e,n,r){var i,s,o,a=/^(AA|A|P|M|m|d|dd)(\d+)$/;if(typeof e=="string"){a=e.match(a);if(!a)throw new Error("Invalid string-interval format");return i=u[a[1]],s=parseInt(a[2],10),new E(s,i,n)}if(typeof n=="string"&&e instanceof w){r==="down"&&(n=t.interval.invert(n)),a=n.match(a);if(!a)throw new Error("Invalid string-interval format");return i=u[a[1]],s=parseInt(a[2],10),o=new E(s,i,r),t.interval.from(e,o)}if(n instanceof w&&e instanceof w)return t.interval.between(e,n);throw new Error("Invalid parameters")},t.interval.from=function(e,i){var s,o,u,a,f;return a=i.simpleInterval-1,a=n[e.name].index+a,a>r.length-1&&(a-=r.length),s=r[a],f=y(e.name,s),o=i.simpleIntervalType.size+i.qualityValue()-f,u=Math.floor((e.key()-e.accidental.value+f-4)/12),u+=1+Math.floor((i.simpleInterval-1)/7),u+=i.compoundOctaves,o+=e.accidental.value,o>=10&&(o-=12),s+=d[o],i.direction==="down"&&u--,t.note(s+u.toString(10))},t.interval.between=function(e,t){var n,r,i,o,u,a="up",f=1;return n=t.key()-e.key(),i=t.key(!0)-e.key(!0),i<0&&(i=-i,a="down",f=-1),r=s[i%7],u=c[r.quality],o=u[(f*n-r.size+2)%12],new E(i+1,o,a)},t.interval.invert=function(e){return t.interval(e).invert().toString()},t.scale=function(e,n){return e instanceof w||(e=t.note(e)),new x(e,n)},t.scale.scales={major:["P1","M2","M3","P4","P5","M6","M7"],ionian:["P1","M2","M3","P4","P5","M6","M7"],dorian:["P1","M2","m3","P4","P5","M6","m7"],phrygian:["P1","m2","m3","P4","P5","m6","m7"],lydian:["P1","M2","M3","A4","P5","M6","M7"],mixolydian:["P1","M2","M3","P4","P5","M6","m7"],minor:["P1","M2","m3","P4","P5","m6","m7"],aeolian:["P1","M2","m3","P4","P5","m6","m7"],locrian:["P1","m2","m3","P4","d5","m6","m7"],majorpentatonic:["P1","M2","M3","P5","M6"],minorpentatonic:["P1","m3","P4","P5","m7"],chromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"],harmonicchromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"]},t.TeoriaNote=w,t.TeoriaChord=S,t.TeoriaScale=x,t.TeoriaInterval=E,typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=t),exports.teoria=t):typeof this!="undefined"?this.teoria=t:typeof window!="undefined"&&(window.teoria=t)})()