(function(){"use strict";function e(e,t){return e=s[e],t=s[t],e.distance>t.distance?t.distance+12-e.distance:t.distance-e.distance}function t(e,t,i){for(;i>0;i--)e+=t;return e}function i(e,t){if("string"!=typeof e)return null;t=t||{},this.name=e,this.duration={value:t.value||4,dots:t.dots||0},this.accidental={value:0,sign:""};var i,n,r,a,o=/^([a-h])(x|#|bb|b?)(-?\d*)/i,s=/^([a-h])(x|#|bb|b?)([,\']*)$/i,l=e.match(o);if(l&&e===l[0]&&0!==l[3].length)r=l[1].toLowerCase(),a=parseInt(l[3],10),l[2].length>0&&(i=l[2].toLowerCase(),n=w[l[2]]);else{if(e=e.replace(/\u2032/g,"'").replace(/\u0375/g,","),l=e.match(s),!l||e!==l[0])throw Error("Invalid note format");if(r=l[1],a=l[3],l[2].length>0&&(i=l[2].toLowerCase(),n=w[l[2]]),0===a.length)a=r===r.toLowerCase()?3:2;else if(a.match(/^'+$/)){if(r===r.toUpperCase())throw Error("Format must respect the Helmholtz notation");a=3+a.length}else{if(!a.match(/^,+$/))throw Error("Invalid characters after note name.");if(r===r.toLowerCase())throw Error("Format must respect the Helmholtz notation");a=2-a.length}}this.name=r.toLowerCase(),this.octave=a,i&&(this.accidental.value=n,this.accidental.sign=i)}function n(e,t,i){var n=e>=8&&1===e%7?8*(e%7):(e-1)%7+1,r=Math.ceil((e-n)/8),a=c[n-1];if(!(t in m[a.quality]))throw Error("Invalid interval quality");this.interval=e,this.quality=t,this.direction="down"===i?"down":"up",this.simpleInterval=n,this.simpleIntervalType=a,this.compoundOctaves=r}function r(e,t){function n(e){for(var t=0,i=e.length;i>t;t++)m[t+1]=e[t];f=e.length}if(!(e instanceof i))return null;t=t||"",this.name=e.name.toUpperCase()+e.accidental.sign+t,this.symbol=t,this.root=e,this.intervals=[],this._voicing=[];var r,a,s,l,h,c,d="quality",u=[],m=["P1","M3","P5","m7","M9","P11","M13"],f=2;for(t=t.replace(/[,\s\(\)]/g,""),h=t.split("/"),2===h.length?(t=h[0],h=h[1]):h=null,r=0,a=t.length;a>r&&(s=t[r]);r++){switch(d){case"quality":l=a>=r+3?t.substr(r,3):null,c=l in p?l:s in p?s:"",n(p[c]),r+=c.length-1,d="extension";break;case"extension":if(s="1"===s&&t[r+1]?parseFloat(t.substr(r,2)):parseFloat(s),isNaN(s)||6===s)6===s?(m[3]="M6",f=3>f?3:f):r-=1;else{if(f=(s-1)/2,f!==Math.round(f))throw Error("Invalid interval extension: "+s.toString(10));("o"===c||"dim"===c)&&(m[3]="d7"),r+=(s+"").length-1}d="alterations";break;case"alterations":var v,g=t.substr(r).split(/(#|b|add|maj|sus|M)/),y=!1,w=!1;if(1===g.length)throw Error("Invalid alterations");if(0!==g[0].length)throw Error("Invalid token: '"+g[0]+"'");for(var M=1,b=g.length;b>M;M++)switch(v=g[M+1],g[M]){case"M":case"maj":f=3>f?3:f,"7"===v&&M++,m[3]="M7";break;case"sus":var P="P4";("2"===v||"4"===v)&&(M++,"2"===v&&(P="M2")),m[1]=P;break;case"add":v&&!isNaN(parseInt(v,10))&&("9"===v?u.push("M9"):"11"===v?u.push("P11"):"13"===v&&u.push("M13"),M+=v.length);break;case"b":y=!0;break;case"#":w=!0;break;default:if(0===g[M].length)break;var I,A,q=parseInt(g[M],10),x=parseInt(g[M],10);if(isNaN(q)||(q+"").length!==g[M].length)throw Error("Invalid token: '"+g[M]+"'");if(6===q){m[3]=w?"A6":y?"m6":"M6",f=3>f?3:f;continue}if(A=(x-1)/2,A>f&&(f=A),5>x||7===x||A!==Math.round(A))throw Error("Invalid interval alteration: "+x.toString(10));I=m[A][0],w?"d"===I?I="m":"m"===I?I="M":("M"===I||"P"===I)&&(I="A"):y&&("A"===I?I="M":"M"===I?I="m":("m"===I||"P"===I)&&(I="d")),m[A]=I+x}d="ended"}if("ended"===d)break}for(this.intervals=m.slice(0,f+1).concat(u).map(function(e){return o.interval(e)}),r=0,a=this.intervals.length;a>r;r++)this._voicing[r]=this.intervals[r];if(h){var k,T,C=this.intervals,E=0;for(T=o.note(h+(e.octave+1)),k=o.interval.between(e,T),h=k.simpleInterval,"up"===k.direction&&(k=k.invert(),k.direction="down"),this._voicing=[k],r=0;a>r;r++)C[r].interval!==h&&(E++,this._voicing[E]=C[r])}}function a(e,t){var n,r,a;if(!(e instanceof i))throw Error("Invalid Tonic");if("string"==typeof t){if(n=t,t=o.scale.scales[t],!t)throw Error("Invalid Scale")}else for(r in o.scale.scales)if(o.scale.scales.hasOwnProperty(r)&&""+o.scale.scales[r]==""+t){n=r;break}for(this.name=n,this.notes=[],this.tonic=e,this.scale=t,r=0,a=t.length;a>r;r++)this.notes.push(o.interval(e,t[r]))}var o={},s={c:{name:"c",distance:0,index:0},d:{name:"d",distance:2,index:1},e:{name:"e",distance:4,index:2},f:{name:"f",distance:5,index:3},g:{name:"g",distance:7,index:4},a:{name:"a",distance:9,index:5},b:{name:"b",distance:11,index:6},h:{name:"h",distance:11,index:6}},l=["c","d","e","f","g","a","b"],h={.25:"longa",.5:"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},c=[{name:"first",quality:"perfect",size:0},{name:"second",quality:"minor",size:1},{name:"third",quality:"minor",size:3},{name:"fourth",quality:"perfect",size:5},{name:"fifth",quality:"perfect",size:7},{name:"sixth",quality:"minor",size:8},{name:"seventh",quality:"minor",size:10},{name:"octave",quality:"perfect",size:12}],d={P:"perfect",M:"major",m:"minor","-":"minor",A:"augmented","+":"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished",min:"minor",aug:"augmented",dim:"diminished"},u={perfect:"P",major:"M",minor:"m",augmented:"A","doubly augmented":"AA",diminished:"d","doubly diminished":"dd"},m={perfect:{"doubly diminished":-2,diminished:-1,perfect:0,augmented:1,"doubly augmented":2},minor:{"doubly diminished":-2,diminished:-1,minor:0,major:1,augmented:2,"doubly augmented":3}},f={perfect:"perfect",major:"minor",minor:"major",augmented:"diminished","doubly augmented":"doubly diminished",diminished:"augmented","doubly diminished":"doubly augmented"},v={perfect:["doubly diminished","diminished","perfect","augmented","doubly augmented"],minor:["doubly diminished","diminished","minor","major","augmented","doubly augmented"]},p={min:["m3","P5"],m:["m3","P5"],"-":["m3","P5"],M:["M3","P5"],"":["M3","P5"],"+":["M3","A5"],aug:["M3","A5"],dim:["m3","d5"],o:["m3","d5"],maj:["M3","P5","M7"],dom:["M3","P5","m7"],"Ã¸":["m3","d5","m7"]},g={major:"M",minor:"m",augmented:"aug",diminished:"dim",power:"5"},y={"-2":"bb","-1":"b",0:"",1:"#",2:"x"},w={bb:-2,b:-1,"#":1,x:2},M={first:"1",tonic:"1",second:"2",third:"3",fourth:"4",fifth:"5",sixth:"6",seventh:"7",ninth:"9",eleventh:"11",thirteenth:"13"},b={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};o.note=function(e,t){return new i(e,t)},o.note.fromKey=function(e){var t=Math.floor((e-4)/12),i=e-12*t-4,n=s[l[Math.round(i/2)]],r=n.name;return i>n.distance?r+="#":n.distance>i&&(r+="b"),o.note(r+(t+1))},o.note.fromFrequency=function(e,t){var i,n,r;return t=t||440,i=49+12*((Math.log(e)-Math.log(t))/Math.log(2)),i=Math.round(i),r=t*Math.pow(2,(i-49)/12),n=1200*(Math.log(e/r)/Math.log(2)),{note:o.note.fromKey(i),cents:n}},o.note.fromMIDI=function(e){return o.note.fromKey(e-20)},o.chord=function(e,t){if("string"==typeof e){var n,a;if(n=e.match(/^([a-h])(x|#|bb|b?)/i),n&&n[0])return a="number"==typeof t?t.toString(10):"4",new r(o.note(n[0].toLowerCase()+a),e.substr(n[0].length))}else if(e instanceof i)return new r(e,t||"");throw Error("Invalid Chord. Couldn't find note name")},o.interval=function(e,t,r){var a,s,l,h;if("string"==typeof e){if(h=e.match(/^(AA|A|P|M|m|d|dd)(-?\d+)$/),!h)throw Error("Invalid string-interval format");return a=d[h[1]],s=parseInt(h[2],10),r="down"===t||0>s?"down":"up",new n(Math.abs(s),a,r)}if("string"==typeof t&&e instanceof i)return l=o.interval(t,r),o.interval.from(e,l);if(t instanceof i&&e instanceof i)return o.interval.between(e,t);throw Error("Invalid parameters")},o.interval.from=function(t,i){var n,r,a,h,c,d,u;return u="down"===i.direction?-1:1,d=i.simpleInterval-1,d=u*d,h=s[t.name].index+d,h>l.length-1?h-=l.length:0>h&&(h+=l.length),n=l[h],c=e(t.name,n),r=u>0?i.simpleIntervalType.size+i.qualityValue()-c:e(n,t.name)-(i.simpleIntervalType.size+i.qualityValue()),r+=t.accidental.value,a=Math.floor((t.key()-t.accidental.value+c-4)/12),a+=1+u*i.compoundOctaves,r>=10?r-=12:-10>=r&&(r+=12),8===i.simpleInterval?a+=u:0>u&&a--,n+=y[r],o.note(n+a.toString(10))},o.interval.between=function(e,t){var i,r,a,o,s,l="up",h=1;return i=t.key()-e.key(),a=t.key(!0)-e.key(!0),0>a&&(a=-a,l="down",h=-1),r=c[a%7],s=v[r.quality],o=s[(h*i-r.size+2)%12],new n(a+1,o,l)},o.interval.invert=function(e){return""+o.interval(e).invert()},o.scale=function(e,t){return e instanceof i||(e=o.note(e)),new a(e,t)},o.scale.scales={},i.prototype={key:function(e){var t;return e?(t=Math.ceil(s[this.name].distance/2),7*(this.octave-1)+3+t):(t=s[this.name].distance+this.accidental.value,12*(this.octave-1)+4+t)},fq:function(e){return e=e||440,e*Math.pow(2,(this.key()-49)/12)},chroma:function(){var e=(s[this.name].distance+this.accidental.value)%12;return 0>e?e+12:e},scale:function(e){return o.scale(this,e)},interval:function(e,t){return o.interval(this,e,t)},transpose:function(e,t){var i=o.interval(this,e,t);return this.name=i.name,this.octave=i.octave,this.accidental=i.accidental,this},chord:function(e){return e=e||"major",e in g&&(e=g[e]),new r(this,e)},helmholtz:function(){var e=3>this.octave?this.name.toUpperCase():this.name.toLowerCase(),i=3>this.octave?",":"'",n=2>this.octave?2-this.octave:this.octave-3;return t(e+this.accidental.sign,i,n)},scientific:function(){return this.name.toUpperCase()+this.accidental.sign+this.octave},enharmonics:function(){var e=[],t=this.key(),i=this.interval("m2","up"),n=this.interval("m2","down"),r=i.key()-i.accidental.value,a=n.key()-n.accidental.value,o=t-r;return 3>o&&o>-3&&(i.accidental={value:o,sign:y[o]},e.push(i)),o=t-a,3>o&&o>-3&&(n.accidental={value:o,sign:y[o]},e.push(n)),e},solfege:function(e,i){if(!(e instanceof a))throw Error("Invalid Scale");var n,r,o,s=e.tonic.interval(this);return"down"===s.direction&&(s=s.invert()),i&&(o=(this.key(!0)-e.tonic.key(!0))/7,o=o>=0?Math.floor(o):-Math.ceil(-o),r=o>=0?"'":","),n=b[s.simple(!0)],i?t(n,r,Math.abs(o)):n},durationName:function(){return h[this.duration.value]},durationInSeconds:function(e,t){var i=60/e/(this.duration.value/4)/(t/4);return 2*i-i/Math.pow(2,this.duration.dots)},scaleDegree:function(e){var t=e.tonic.interval(this);return t="down"===t.direction||8===t.simpleInterval?t.invert():t,e.scale.indexOf(t.simple(!0))+1},toString:function(e){var t=e?"":this.octave;return this.name.toLowerCase()+this.accidental.sign+t}},n.prototype={semitones:function(){return this.simpleIntervalType.size+this.qualityValue()+12*this.compoundOctaves},simple:function(e){var t=this.simpleInterval;return t="down"!==this.direction||e?t:-t,u[this.quality]+(""+t)},compound:function(e){var t=this.simpleInterval+7*this.compoundOctaves;return t="down"!==this.direction||e?t:-t,u[this.quality]+(""+t)},isCompound:function(){return this.compoundOctaves>0},invert:function(){var e=this.simpleInterval;return e=9-e,new n(e,f[this.quality],this.direction)},qualityValue:function(){var e=this.simpleIntervalType.quality,t=this.quality;return m[e][t]},equal:function(e){return this.interval===e.interval&&this.quality===e.quality},greater:function(e){var t=this.semitones(),i=e.semitones();return t===i?this.interval>e.interval:t>i},smaller:function(e){return!this.equal(e)&&!this.greater(e)},toString:function(){return this.compound()}},r.prototype={notes:function(){for(var e=this.voicing(),t=[],i=0,n=e.length;n>i;i++)t.push(o.interval.from(this.root,e[i]));return t},voicing:function(e){if(!e)return this._voicing;this._voicing=[];for(var t=0,i=e.length;i>t;t++)this._voicing[t]=o.interval(e[t]);return this},resetVoicing:function(){this._voicing=this.intervals},dominant:function(e){return e=e||"",new r(this.root.interval("P5"),e)},subdominant:function(e){return e=e||"",new r(this.root.interval("P4"),e)},parallel:function(e){e=e||"";var t=this.quality();if("triad"!==this.chordType()||"diminished"===t||"augmented"===t)throw Error("Only major/minor triads have parallel chords");return"major"===t?new r(this.root.interval("m3","down"),"m"):new r(this.root.interval("m3","up"))},quality:function(){for(var e,t,i,n=this.intervals,r=0,a=n.length;a>r;r++)3===n[r].interval?e=n[r]:5===n[r].interval?t=n[r]:7===n[r].interval&&(i=n[r]);return e?(e="down"===e.direction?e.invert():e,e=e.simple(),t&&(t="down"===t.direction?t.invert():t,t=t.simple()),i&&(i="down"===i.direction?i.invert():i,i=i.simple()),"M3"===e?"A5"===t?"augmented":"P5"===t?"m7"===i?"dominant":"major":"major":"m3"===e?"P5"===t?"minor":"d5"===t?"m7"===i?"half-diminished":"diminished":"minor":void 0):void 0},chordType:function(){var e,t,i,n,r,a=this.intervals.length;if(2===a)return"dyad";if(3===a){for(t={first:!1,third:!1,fifth:!1},n=0;a>n;n++)e=this.intervals[n],i=e.invert(),e.simpleIntervalType.name in t?t[e.simpleIntervalType.name]=!0:i.simpleIntervalType.name in t&&(t[i.simpleIntervalType.name]=!0);r=t.first&&t.third&&t.fifth?"triad":"trichord"}else if(4===a){for(t={first:!1,third:!1,fifth:!1,seventh:!1},n=0;a>n;n++)e=this.intervals[n],i=e.invert(),e.simpleIntervalType.name in t?t[e.simpleIntervalType.name]=!0:i.simpleIntervalType.name in t&&(t[i.simpleIntervalType.name]=!0);t.first&&t.third&&t.fifth&&t.seventh&&(r="tetrad")}return r||"unknown"},get:function(e){if("string"==typeof e&&e in M){var t,i,n=this.intervals;for(e=M[e],t=0,i=n.length;i>t;t++)if(n[t].interval===+e)return o.interval.from(this.root,n[t]);return null}throw Error("Invalid interval name")},interval:function(e,t){return new r(this.root.interval(e,t),this.symbol)},transpose:function(e,t){return this.root.transpose(e,t),this.name=this.root.name.toUpperCase()+this.root.accidental.sign+this.symbol,this},toString:function(){return this.name}},a.prototype={simple:function(){for(var e=[],t=0,i=this.notes.length;i>t;t++)e.push(this.notes[t].toString(!0));return e},type:function(){var e=this.notes.length-2;return 8>e?["di","tri","tetra","penta","hexa","hepta","octa"][e]+"tonic":void 0},get:function(e){return"string"==typeof e&&e in M&&(e=parseInt(M[e],10)),this.notes[e-1]},solfege:function(e,t){var i,n,r=[];if(e)return this.get(e).solfege(this,t);for(i=0,n=this.notes.length;n>i;i++)r.push(this.notes[i].solfege(this,t));return r},interval:function(e,t){return new a(this.tonic.interval(e,t),this.scale)},transpose:function(e,t){var i=new a(this.tonic.interval(e,t),this.scale);return this.notes=i.notes,this.scale=i.scale,this.tonic=i.tonic,this}},o.scale.scales.ionian=o.scale.scales.major=["P1","M2","M3","P4","P5","M6","M7"],o.scale.scales.dorian=["P1","M2","m3","P4","P5","M6","m7"],o.scale.scales.phrygian=["P1","m2","m3","P4","P5","m6","m7"],o.scale.scales.lydian=["P1","M2","M3","A4","P5","M6","M7"],o.scale.scales.mixolydian=["P1","M2","M3","P4","P5","M6","m7"],o.scale.scales.aeolian=o.scale.scales.minor=["P1","M2","m3","P4","P5","m6","m7"],o.scale.scales.locrian=["P1","m2","m3","P4","d5","m6","m7"],o.scale.scales.majorpentatonic=["P1","M2","M3","P5","M6"],o.scale.scales.minorpentatonic=["P1","m3","P4","P5","m7"],o.scale.scales.chromatic=o.scale.scales.harmonicchromatic=["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"],o.TeoriaNote=i,o.TeoriaChord=r,o.TeoriaScale=a,o.TeoriaInterval=n,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.teoria=o):this!==void 0?this.teoria=o:"undefined"!=typeof window&&(window.teoria=o)})();