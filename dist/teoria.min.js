(function(){"use strict";function t(t,e){return t=s[t],e=s[e],t.distance>e.distance?e.distance+12-t.distance:e.distance-t.distance}function e(t,e,n){for(;n>0;n--)t+=e;return t}function n(t,e){if("string"!=typeof t)return null;e=e||{},this.name=t,this.duration={value:e.value||4,dots:e.dots||0},this.accidental={value:0,sign:""};var n,i,r,a,o=/^([a-h])(x|#|bb|b?)(-?\d*)/i,s=/^([a-h])(x|#|bb|b?)([,\']*)$/i,l=t.match(o);if(l&&t===l[0]&&0!==l[3].length)r=l[1].toLowerCase(),a=parseInt(l[3],10),l[2].length>0&&(n=l[2].toLowerCase(),i=M[l[2]]);else{if(t=t.replace(/\u2032/g,"'").replace(/\u0375/g,","),l=t.match(s),!l||t!==l[0])throw Error("Invalid note format");if(r=l[1],a=l[3],l[2].length>0&&(n=l[2].toLowerCase(),i=M[l[2]]),0===a.length)a=r===r.toLowerCase()?3:2;else if(a.match(/^'+$/)){if(r===r.toUpperCase())throw Error("Format must respect the Helmholtz notation");a=3+a.length}else{if(!a.match(/^,+$/))throw Error("Invalid characters after note name.");if(r===r.toLowerCase())throw Error("Format must respect the Helmholtz notation");a=2-a.length}}this.name=r.toLowerCase(),this.octave=a,n&&(this.accidental.value=i,this.accidental.sign=n)}function i(t,e,n){var i=t>=8&&1===t%7?8*(t%7):(t-1)%7+1,r=Math.ceil((t-i)/8),a=d[i-1];if(!(e in f[a.quality]))throw Error("Invalid interval quality");this.interval=t,this.quality=e,this.direction="down"===n?"down":"up",this.simpleInterval=i,this.simpleIntervalType=a,this.compoundOctaves=r}function r(t,e){function i(t){for(var e=0,n=t.length;n>e;e++)f[e]=t[e];v=t.length}if(!(t instanceof n))return null;e=e||"",this.name=t.name.toUpperCase()+t.accidental.sign+e,this.symbol=e,this.root=t,this.notes=[t];var r,a,s,l,h,d,m,u="quality",c=[],f=["M3","P5","m7","M9","P11","M13"],v=2;for(e=e.replace(/[,\s\(\)]/g,""),h=e.split("/"),2===h.length?(e=h[0],h=h[1]):h=null,r=0,a=e.length;a>r&&(s=e[r]);r++){switch(u){case"quality":l=a>=r+3?e.substr(r,3):null,m=l in g?l:s in g?s:"",i(g[m]),r+=m.length-1,u="extension";break;case"extension":if(s="1"===s&&e[r+1]?parseFloat(e.substr(r,2)):parseFloat(s),isNaN(s)||6===s)6===s?(f[2]="M6",v=3>v?3:v):r-=1;else{if(v=(s-1)/2,v!==Math.round(v))throw Error("Invalid interval extension: "+s.toString(10));("o"===m||"dim"===m)&&(f[2]="d7"),r+=(s+"").length-1}u="alterations";break;case"alterations":var p,y=e.substr(r).split(/(#|b|add|maj|sus)/),w=!1,M=!1;if(1===y.length)throw Error("Invalid alterations");if(0!==y[0].length)throw Error("Invalid token: '"+y[0]+"'");for(var b=1,P=y.length;P>b;b++)switch(p=y[b+1],y[b]){case"maj":v=3>v?3:v,"7"===p&&b++,f[2]="M7";break;case"sus":var I="P4";("2"===p||"4"===p)&&(b++,"2"===p&&(I="M2")),f[0]=I;break;case"add":p&&!isNaN(parseInt(p,10))&&("9"===p?c.push("M9"):"11"===p?c.push("P11"):"13"===p&&c.push("M13"),b+=p.length);break;case"b":w=!0;break;case"#":M=!0;break;default:if(0===y[b].length)break;var A,q,x=parseInt(y[b],10),k=parseInt(y[b],10);if(isNaN(x)||(x+"").length!==y[b].length)throw Error("Invalid token: '"+y[b]+"'");if(6===x){f[2]=M?"A6":w?"m6":"M6",v=3>v?3:v;continue}if(q=(k-1)/2-1,q+1>v&&(v=q+1),5>k||7===k||q!==Math.round(q))throw Error("Invalid interval alteration: "+k.toString(10));A=f[q][0],M?"d"===A?A="m":"m"===A?A="M":("M"===A||"P"===A)&&(A="A"):w&&("A"===A?A="M":"M"===A?A="m":("m"===A||"P"===A)&&(A="d")),f[q]=A+k}u="ended"}if("ended"===u)break}if(f=f.slice(0,v).concat(c),h){h=o.note(h);var E=o.interval.between(t,h);h.octave-="up"===E.direction?1:0,this.notes.splice(0,0,h)}for(r=0;f.length>r;r++)d=this.root.interval(f[r]),h&&d.toString(!0)===h.toString(!0)||this.notes.push(d)}function a(t,e){var i,r,a;if(!(t instanceof n))throw Error("Invalid Tonic");if("string"==typeof e){if(i=e,e=o.scale.scales[e],!e)throw Error("Invalid Scale")}else for(r in o.scale.scales)if(o.scale.scales.hasOwnProperty(r)&&""+o.scale.scales[r]==""+e){i=r;break}for(this.name=i,this.notes=[],this.tonic=t,this.scale=e,r=0,a=e.length;a>r;r++)this.notes.push(o.interval(t,e[r]))}var o={},s={c:{name:"c",distance:0,index:0},d:{name:"d",distance:2,index:1},e:{name:"e",distance:4,index:2},f:{name:"f",distance:5,index:3},g:{name:"g",distance:7,index:4},a:{name:"a",distance:9,index:5},b:{name:"b",distance:11,index:6},h:{name:"h",distance:11,index:6}},l=["c","d","e","f","g","a","b"],h={.25:"longa",.5:"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},d=[{name:"first",quality:"perfect",size:0},{name:"second",quality:"minor",size:1},{name:"third",quality:"minor",size:3},{name:"fourth",quality:"perfect",size:5},{name:"fifth",quality:"perfect",size:7},{name:"sixth",quality:"minor",size:8},{name:"seventh",quality:"minor",size:10},{name:"octave",quality:"perfect",size:12}],m={first:0,second:1,third:2,fourth:3,fifth:4,sixth:5,seventh:6,octave:7,ninth:8,tenth:9,eleventh:10,twelfth:11,thirteenth:12,fourteenth:13,fifteenth:14},u={P:"perfect",M:"major",m:"minor","-":"minor",A:"augmented","+":"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished",min:"minor",aug:"augmented",dim:"diminished"},c={perfect:"P",major:"M",minor:"m",augmented:"A","doubly augmented":"AA",diminished:"d","doubly diminished":"dd"},f={perfect:{"doubly diminished":-2,diminished:-1,perfect:0,augmented:1,"doubly augmented":2},minor:{"doubly diminished":-2,diminished:-1,minor:0,major:1,augmented:2,"doubly augmented":3}},v={perfect:"perfect",major:"minor",minor:"major",augmented:"diminished","doubly augmented":"doubly diminished",diminished:"augmented","doubly diminished":"doubly augmented"},p={perfect:["doubly diminished","diminished","perfect","augmented","doubly augmented"],minor:["doubly diminished","diminished","minor","major","augmented","doubly augmented"]},g={min:["m3","P5"],m:["m3","P5"],"-":["m3","P5"],M:["M3","P5"],"":["M3","P5"],"+":["M3","A5"],aug:["M3","A5"],dim:["m3","d5"],o:["m3","d5"],maj:["M3","P5","M7"],dom:["M3","P5","m7"],"Ã¸":["m3","d5","m7"]},y={major:"M",minor:"m",augmented:"aug",diminished:"dim",power:"5"},w={"-2":"bb","-1":"b",0:"",1:"#",2:"x"},M={bb:-2,b:-1,"#":1,x:2},b={first:"1",tonic:"1",second:"2",third:"3",fourth:"4",fifth:"5",sixth:"6",seventh:"7",ninth:"9",eleventh:"11",thirteenth:"13"},P={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};n.prototype={key:function(t){var e;return t?(e=Math.ceil(s[this.name].distance/2),7*(this.octave-1)+3+e):(e=s[this.name].distance+this.accidental.value,12*(this.octave-1)+4+e)},fq:function(t){return t=t||440,t*Math.pow(2,(this.key()-49)/12)},chroma:function(){var t=(s[this.name].distance+this.accidental.value)%12;return 0>t?t+12:t},scale:function(t){return o.scale(this,t)},interval:function(t,e){return o.interval(this,t,e)},transpose:function(t,e){var n=o.interval(this,t,e);return this.name=n.name,this.octave=n.octave,this.accidental=n.accidental,this},chord:function(t){return t=t||"major",t in y&&(t=y[t]),new r(this,t)},helmholtz:function(){var t=3>this.octave?this.name.toUpperCase():this.name.toLowerCase(),n=3>this.octave?",":"'",i=2>this.octave?2-this.octave:this.octave-3;return e(t+this.accidental.sign,n,i)},scientific:function(){return this.name.toUpperCase()+this.accidental.sign+this.octave},enharmonics:function(){var t=[],e=this.key(),n=this.interval("m2","up"),i=this.interval("m2","down"),r=n.key()-n.accidental.value,a=i.key()-i.accidental.value,o=e-r;return 3>o&&o>-3&&(n.accidental={value:o,sign:w[o]},t.push(n)),o=e-a,3>o&&o>-3&&(i.accidental={value:o,sign:w[o]},t.push(i)),t},solfege:function(t,n){if(!(t instanceof a))throw Error("Invalid Scale");var i,r,o,s=t.tonic.interval(this);return"down"===s.direction&&(s=s.invert()),n&&(o=(this.key(!0)-t.tonic.key(!0))/7,o=o>=0?Math.floor(o):-Math.ceil(-o),r=o>=0?"'":","),i=P[s.simple()],n?e(i,r,Math.abs(o)):i},durationName:function(){return h[this.duration.value]},durationInSeconds:function(t,e){var n=60/t/(this.duration.value/4)/(e/4);return 2*n-n/Math.pow(2,this.duration.dots)},scaleDegree:function(t){var e=t.tonic.interval(this);return e="down"===e.direction||8===e.simpleInterval?e.invert():e,t.scale.indexOf(e.simple())+1},toString:function(t){var e=t?"":this.octave;return this.name.toLowerCase()+this.accidental.sign+e}},i.prototype={semitones:function(){return this.simpleIntervalType.size+this.qualityValue()+12*this.compoundOctaves},simple:function(){return c[this.quality]+(""+this.simpleInterval)},compound:function(){return c[this.quality]+(""+(this.simpleInterval+7*this.compoundOctaves))},isCompound:function(){return this.compoundOctaves>0},invert:function(){var t=this.simpleInterval;return t=9-t,new i(t,v[this.quality])},qualityValue:function(){var t=this.simpleIntervalType.quality,e=this.quality;return f[t][e]},equal:function(t){return this.interval===t.interval&&this.quality===t.quality},greater:function(t){var e=this.semitones(),n=t.semitones();return e===n?this.interval>t.interval:e>n},smaller:function(t){return!this.equal(t)&&!this.greater(t)},toString:function(){return this.compound()}},r.prototype={dominant:function(t){return t=t||"",new r(this.root.interval("P5"),t)},subdominant:function(t){return t=t||"",new r(this.root.interval("P4"),t)},parallel:function(t){t=t||"";var e=this.quality();if("triad"!==this.chordType()||"diminished"===e||"augmented"===e)throw Error("Only major/minor triads have parallel chords");return"major"===e?new r(this.root.interval("m3","down"),"m"):new r(this.root.interval("m3","up"))},quality:function(){var t=this.get("third"),e=this.get("fifth"),n=this.get("seventh");if(t)return t=this.root.interval(t),t="down"===t.direction?t.invert():t,t=t.simple(),e&&(e=this.root.interval(e),e="down"===e.direction?e.invert():e,e=e.simple()),n&&(n=this.root.interval(n),n="down"===n.direction?n.invert():n,n=n.simple()),"M3"===t?"A5"===e?"augmented":"P5"===e?"m7"===n?"dominant":"major":"major":"m3"===t?"P5"===e?"minor":"d5"===e?"m7"===n?"half-diminished":"diminished":"minor":void 0},chordType:function(){var t,e,n,i,r,a=this.notes.length;if(2===a)return"dyad";if(3===a){for(e={first:!1,third:!1,fifth:!1},i=0;a>i;i++)t=this.root.interval(this.notes[i]),n=t.invert(),t.simpleIntervalType.name in e?e[t.simpleIntervalType.name]=!0:n.simpleIntervalType.name in e&&(e[n.simpleIntervalType.name]=!0);r=e.first&&e.third&&e.fifth?"triad":"trichord"}else if(4===a){for(e={first:!1,third:!1,fifth:!1,seventh:!1},i=0;a>i;i++)t=this.root.interval(this.notes[i]),n=t.invert(),t.simpleIntervalType.name in e?e[t.simpleIntervalType.name]=!0:n.simpleIntervalType.name in e&&(e[n.simpleIntervalType.name]=!0);e.first&&e.third&&e.fifth&&e.seventh&&(r="tetrad")}return r||"unknown"},get:function(t){if("string"==typeof t&&t in b){var e=d[m[t]].quality;e="perfect"===e?"P":"M",t=this.root.interval(e+b[t]);for(var n=0,i=this.notes.length;i>n;n++)if(this.notes[n].name===t.name)return this.notes[n];return null}throw Error("Invalid interval name")},interval:function(t,e){return new r(this.root.interval(t,e),this.symbol)},transpose:function(t,e){var n=new r(this.root.interval(t,e),this.symbol);return this.name=n.name,this.symbol=n.symbol,this.root=n.root,this.notes=n.notes,this},toString:function(){return this.name}},a.prototype={simple:function(){for(var t=[],e=0,n=this.notes.length;n>e;e++)t.push(this.notes[e].toString(!0));return t},type:function(){var t=this.notes.length-2;return 8>t?["di","tri","tetra","penta","hexa","hepta","octa"][t]+"tonic":void 0},get:function(t){return"string"==typeof t&&t in b&&(t=parseInt(b[t],10)),this.notes[t-1]},solfege:function(t,e){var n,i,r=[];if(t)return this.get(t).solfege(this,e);for(n=0,i=this.notes.length;i>n;n++)r.push(this.notes[n].solfege(this,e));return r},interval:function(t,e){return new a(this.tonic.interval(t,e),this.scale)},transpose:function(t,e){var n=new a(this.tonic.interval(t,e),this.scale);return this.notes=n.notes,this.scale=n.scale,this.tonic=n.tonic,this}},o.note=function(t,e){return new n(t,e)},o.note.fromKey=function(t){var e=Math.floor((t-4)/12),n=t-12*e-4,i=s[l[Math.round(n/2)]],r=i.name;return n>i.distance?r+="#":i.distance>n&&(r+="b"),o.note(r+(e+1))},o.note.fromFrequency=function(t,e){var n,i,r;return e=e||440,n=49+12*((Math.log(t)-Math.log(e))/Math.log(2)),n=Math.round(n),r=e*Math.pow(2,(n-49)/12),i=1200*(Math.log(t/r)/Math.log(2)),{note:o.note.fromKey(n),cents:i}},o.note.fromMIDI=function(t){return o.note.fromKey(t-20)},o.chord=function(t,e){if("string"==typeof t){var i,a;if(i=t.match(/^([a-h])(x|#|bb|b?)/i),i&&i[0])return a="number"==typeof e?e.toString(10):"4",new r(o.note(i[0].toLowerCase()+a),t.substr(i[0].length))}else if(t instanceof n)return new r(t,e||"");throw Error("Invalid Chord. Couldn't find note name")},o.interval=function(t,e,r){var a,s,l,h=/^(AA|A|P|M|m|d|dd)(\d+)$/;if("string"==typeof t){if(h=t.match(h),!h)throw Error("Invalid string-interval format");return a=u[h[1]],s=parseInt(h[2],10),new i(s,a,e)}if("string"==typeof e&&t instanceof n){if("down"===r&&(e=o.interval.invert(e)),h=e.match(h),!h)throw Error("Invalid string-interval format");return a=u[h[1]],s=parseInt(h[2],10),l=new i(s,a,r),o.interval.from(t,l)}if(e instanceof n&&t instanceof n)return o.interval.between(t,e);throw Error("Invalid parameters")},o.interval.from=function(e,n){var i,r,a,h,d;return h=n.simpleInterval-1,h=s[e.name].index+h,h>l.length-1&&(h-=l.length),i=l[h],d=t(e.name,i),r=n.simpleIntervalType.size+n.qualityValue()-d,a=Math.floor((e.key()-e.accidental.value+d-4)/12),a+=1+Math.floor((n.simpleInterval-1)/7),a+=n.compoundOctaves,r+=e.accidental.value,r>=10&&(r-=12),i+=w[r],"down"===n.direction&&a--,o.note(i+a.toString(10))},o.interval.between=function(t,e){var n,r,a,o,s,l="up",h=1;return n=e.key()-t.key(),a=e.key(!0)-t.key(!0),0>a&&(a=-a,l="down",h=-1),r=d[a%7],s=p[r.quality],o=s[(h*n-r.size+2)%12],new i(a+1,o,l)},o.interval.invert=function(t){return""+o.interval(t).invert()},o.scale=function(t,e){return t instanceof n||(t=o.note(t)),new a(t,e)},o.scale.scales={major:["P1","M2","M3","P4","P5","M6","M7"],ionian:["P1","M2","M3","P4","P5","M6","M7"],dorian:["P1","M2","m3","P4","P5","M6","m7"],phrygian:["P1","m2","m3","P4","P5","m6","m7"],lydian:["P1","M2","M3","A4","P5","M6","M7"],mixolydian:["P1","M2","M3","P4","P5","M6","m7"],minor:["P1","M2","m3","P4","P5","m6","m7"],aeolian:["P1","M2","m3","P4","P5","m6","m7"],locrian:["P1","m2","m3","P4","d5","m6","m7"],majorpentatonic:["P1","M2","M3","P5","M6"],minorpentatonic:["P1","m3","P4","P5","m7"],chromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"],harmonicchromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"]},o.TeoriaNote=n,o.TeoriaChord=r,o.TeoriaScale=a,o.TeoriaInterval=i,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.teoria=o):this!==void 0?this.teoria=o:"undefined"!=typeof window&&(window.teoria=o)})();